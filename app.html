<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safebut? - Pregnancy Safety Checker</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§∞Safebut?</h1>
            <p class="subtitle">Check the safety of anything during pregnancy</p>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="search">üîç Search</button>
                <button class="tab-btn" data-tab="profile">üë§ Profile</button>
                <button class="tab-btn" data-tab="history">üìú History</button>
                <button class="tab-btn" data-tab="log" id="logTabBtn">üìù Log</button>
                <button class="tab-btn" data-tab="upgrade">üöÄ Upgrade</button>
                <button class="tab-btn logout-btn" id="logoutBtn" onclick="logout()">üö™ Logout</button>
            </div>
        </header>

        <main>
            <!-- Search Tab Content -->
            <div id="searchTab" class="tab-content active">
                <div class="search-section">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Enter anything to check if it's safe (e.g., 'coffee', 'flying', 'yoga', 'hot tubs')"
                        autocomplete="off"
                    >
                    <button id="cameraBtn" type="button" class="camera-btn" title="Take a photo">
                        üì∑
                    </button>
                    <button id="searchBtn" type="button">
                        <span class="btn-text">Check Safety</span>
                        <span class="loader" style="display: none;"></span>
                    </button>
                </div>
                
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                
                <div id="imagePreview" class="image-preview" style="display: none;">
                    <img id="capturedImage" alt="Captured image">
                    <button id="removeImage" class="remove-image">‚úï</button>
                </div>
                <div class="example-chips">
                    <span class="chip" data-example="coffee">Coffee</span>
                    <span class="chip" data-example="sushi">Sushi</span>
                    <span class="chip" data-example="flying">Flying</span>
                    <span class="chip" data-example="yoga">Yoga</span>
                    <span class="chip" data-example="hot tubs">Hot Tubs</span>
                    <span class="chip" data-example="hair dye">Hair Dye</span>
                </div>
            </div>

            <div id="results" class="results-section" style="display: none;">
                <div class="result-card">
                    <div class="result-header">
                        <h2 id="itemName"></h2>
                        <span id="safetyBadge" class="safety-badge"></span>
                    </div>
                    
                    <div id="safetyVerdict" class="safety-verdict"></div>
                    
                    <div class="risk-scale">
                        <h3>Risk Level Assessment</h3>
                        <div class="risk-meter">
                            <div id="riskIndicator" class="risk-indicator">5</div>
                        </div>
                        <div class="risk-labels">
                            <span>1 (Safest)</span>
                            <span>5 (Moderate)</span>
                            <span>10 (Most Risky)</span>
                        </div>
                    </div>
                    
                    <div id="resultContent" class="result-content"></div>
                    
                    <!-- More Details Section -->
                    <div id="detailsSection" class="details-section">
                        <button id="getDetailsBtn" class="get-details-btn">
                            <span class="details-btn-text">üîç Get More Detailed Answer</span>
                            <span class="details-loader" style="display: none;"></span>
                        </button>
                        <div id="detailedContent" class="detailed-content" style="display: none;">
                            <h3>üìã Detailed Analysis</h3>
                            <div id="detailedAnswer"></div>
                        </div>
                    </div>
                    
                    <div id="referencesSection" class="references-section">
                        <h3>üìö Learn More</h3>
                        <div id="referenceLinks"></div>
                    </div>
                    
                    <div class="disclaimer">
                        <strong>‚ö†Ô∏è Important:</strong> This information is AI-generated and should not replace professional medical advice. Always consult your healthcare provider before making any decisions during pregnancy.
                    </div>
                </div>
            </div>

                <div id="error" class="error-message" style="display: none;">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span id="errorText"></span>
                </div>
            </div>
            
            <!-- Profile Tab Content -->
            <div id="profileTab" class="tab-content" style="display: none;">
                <div class="profile-section">
                    <h2>Your Health Profile</h2>
                    <p class="profile-intro">Fill in your information for personalized safety recommendations:</p>
                    
                    <!-- Basic Profile Information -->
                    <div class="basic-info">
                        <h3>üë§ Basic Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="profile-name">Name</label>
                                <input type="text" id="profile-name" placeholder="Your name">
                            </div>
                            
                            <div class="form-group">
                                <label for="profile-age">Age</label>
                                <input type="number" id="profile-age" placeholder="Your age" min="16" max="60">
                            </div>
                            
                            <div class="form-group">
                                <label for="due-date">Due Date</label>
                                <input type="date" id="due-date">
                            </div>
                            
                            <div class="form-group">
                                <label for="weeks-pregnant">Weeks Pregnant</label>
                                <input type="number" id="weeks-pregnant" placeholder="Current week" min="1" max="42">
                            </div>
                            
                            <div class="form-group">
                                <label for="pregnancy-number">Pregnancy Number</label>
                                <select id="pregnancy-number">
                                    <option value="">Select...</option>
                                    <option value="1">First pregnancy</option>
                                    <option value="2">Second pregnancy</option>
                                    <option value="3">Third pregnancy</option>
                                    <option value="4+">Fourth or more</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="healthcare-provider">Healthcare Provider</label>
                                <input type="text" id="healthcare-provider" placeholder="Doctor/Midwife name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-conditions">
                        <h3>ü©∫ Medical Conditions</h3>
                        <div class="condition-grid">
                            <label class="condition-toggle">
                                <input type="checkbox" id="gestational-diabetes" name="conditions">
                                <span class="toggle-label">Gestational Diabetes</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="preeclampsia" name="conditions">
                                <span class="toggle-label">Preeclampsia / High Blood Pressure</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="anemia" name="conditions">
                                <span class="toggle-label">Anemia</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="thyroid" name="conditions">
                                <span class="toggle-label">Thyroid Disorders</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="placenta-previa" name="conditions">
                                <span class="toggle-label">Placenta Previa</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="hyperemesis" name="conditions">
                                <span class="toggle-label">Hyperemesis Gravidarum</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="rh-negative" name="conditions">
                                <span class="toggle-label">Rh Negative Blood Type</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="multiples" name="conditions">
                                <span class="toggle-label">Multiple Pregnancy (Twins/Triplets)</span>
                            </label>
                        </div>
                        
                        <h3>‚ö†Ô∏è Risk Factors</h3>
                        <div class="condition-grid">
                            <label class="condition-toggle">
                                <input type="checkbox" id="high-risk" name="risk-factors">
                                <span class="toggle-label">High-Risk Pregnancy</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="over-35" name="risk-factors">
                                <span class="toggle-label">Age 35 or Older</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="previous-miscarriage" name="risk-factors">
                                <span class="toggle-label">Previous Miscarriage</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="ivf" name="risk-factors">
                                <span class="toggle-label">IVF Pregnancy</span>
                            </label>
                        </div>
                        
                        <h3>üçΩÔ∏è Dietary Restrictions</h3>
                        <div class="condition-grid">
                            <label class="condition-toggle">
                                <input type="checkbox" id="vegetarian" name="diet">
                                <span class="toggle-label">Vegetarian</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="vegan" name="diet">
                                <span class="toggle-label">Vegan</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="gluten-free" name="diet">
                                <span class="toggle-label">Gluten-Free</span>
                            </label>
                            
                            <label class="condition-toggle">
                                <input type="checkbox" id="lactose-intolerant" name="diet">
                                <span class="toggle-label">Lactose Intolerant</span>
                            </label>
                        </div>
                        
                        <h3>üìÖ Pregnancy Stage</h3>
                        <div class="trimester-selector">
                            <label class="radio-option">
                                <input type="radio" name="trimester" value="first" id="first-trimester">
                                <span class="radio-label">First Trimester (Weeks 1-12)</span>
                            </label>
                            
                            <label class="radio-option">
                                <input type="radio" name="trimester" value="second" id="second-trimester">
                                <span class="radio-label">Second Trimester (Weeks 13-27)</span>
                            </label>
                            
                            <label class="radio-option">
                                <input type="radio" name="trimester" value="third" id="third-trimester">
                                <span class="radio-label">Third Trimester (Weeks 28-40)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Response Preferences -->
                    <div class="preferences-section">
                        <h3>‚öôÔ∏è Response Preferences</h3>
                        <p class="preferences-intro">Customize how Venice AI provides recommendations:</p>
                        
                        <!-- Measurement System -->
                        <div class="preference-group">
                            <h4>üìè Measurement System</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="measurement-system" value="imperial" id="imperial-system">
                                    <span class="radio-label">Imperial (lbs, ¬∞F, cups, inches)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="measurement-system" value="metric" id="metric-system">
                                    <span class="radio-label">Metric (kg, ¬∞C, ml, cm)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Caffeine Measurement -->
                        <div class="preference-group">
                            <h4>‚òï Caffeine Measurement</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="caffeine-measurement" value="cups" id="caffeine-cups">
                                    <span class="radio-label">Cups/Servings (1-2 cups of coffee)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="caffeine-measurement" value="milligrams" id="caffeine-mg">
                                    <span class="radio-label">Milligrams (200mg caffeine limit)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Temperature Preference -->
                        <div class="preference-group">
                            <h4>üå°Ô∏è Temperature Unit</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="temperature-unit" value="fahrenheit" id="temp-fahrenheit">
                                    <span class="radio-label">Fahrenheit (¬∞F)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="temperature-unit" value="celsius" id="temp-celsius">
                                    <span class="radio-label">Celsius (¬∞C)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Weight/Dosage Preference -->
                        <div class="preference-group">
                            <h4>‚öñÔ∏è Weight & Dosage</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="weight-unit" value="imperial" id="weight-imperial">
                                    <span class="radio-label">Imperial (lbs, ounces)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="weight-unit" value="metric" id="weight-metric">
                                    <span class="radio-label">Metric (kg, grams)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Response Detail Level -->
                        <div class="preference-group">
                            <h4>üìñ Response Detail Level</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="detail-level" value="brief" id="detail-brief">
                                    <span class="radio-label">Brief (Quick answers, key points only)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="detail-level" value="detailed" id="detail-detailed">
                                    <span class="radio-label">Detailed (Comprehensive explanations)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Scientific vs Layman -->
                        <div class="preference-group">
                            <h4>üß¨ Language Style</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="language-style" value="simple" id="language-simple">
                                    <span class="radio-label">Simple Language (Easy to understand)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="language-style" value="scientific" id="language-scientific">
                                    <span class="radio-label">Scientific Terms (Medical terminology)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Risk Communication Style -->
                        <div class="preference-group">
                            <h4>‚ö†Ô∏è Risk Communication</h4>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="risk-style" value="reassuring" id="risk-reassuring">
                                    <span class="radio-label">Reassuring (Focus on what's safe)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="risk-style" value="cautious" id="risk-cautious">
                                    <span class="radio-label">Cautious (Emphasize potential risks)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="risk-style" value="balanced" id="risk-balanced">
                                    <span class="radio-label">Balanced (Neutral presentation)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="saveProfile" class="save-profile-btn">üíæ Save Profile</button>
                    
                    <div class="profile-note">
                        <p>üîí Your health information is stored locally and only used to personalize your safety recommendations.</p>
                    </div>
                </div>
            </div>
            
            <!-- History Tab Content -->
            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="history-section">
                    <div class="history-header">
                        <h3>Search History</h3>
                        <button id="clearHistory" class="clear-history">Clear All</button>
                    </div>
                    <div id="historyItems" class="history-items"></div>
                </div>
            </div>

            <!-- Log Tab Content (Premium Feature) -->
            <div id="logTab" class="tab-content" style="display: none;">
                <div class="log-section">
                    <!-- Log Input Section -->
                    <div class="log-input-section">
                        <h2>üìù Pregnancy Log</h2>
                        <p class="log-subtitle">Track your pregnancy journey with voice or text entries</p>
                        
                        <div class="log-input-container">
                            <!-- Text Input -->
                            <textarea id="logTextInput" class="log-text-input" placeholder="What happened today? (e.g., 'Felt baby kick for the first time', 'Had morning sickness after breakfast', 'Went to prenatal yoga class')"></textarea>
                            
                            <!-- Voice Recording Controls -->
                            <div class="voice-controls">
                                <button id="voiceRecordBtn" class="voice-record-btn">
                                    üé§ Hold to Record Voice Note
                                </button>
                                <div id="recordingIndicator" class="recording-indicator" style="display: none;">
                                    <span class="recording-dot"></span> Recording...
                                </div>
                                <audio id="voicePreview" style="display: none;" controls></audio>
                            </div>
                            
                            <button id="saveLogEntry" class="save-log-btn">üíæ Save Entry</button>
                        </div>
                    </div>
                    
                    <!-- Calendar View Section -->
                    <div class="calendar-section">
                        <div class="calendar-header">
                            <button id="prevMonth" class="calendar-nav">‚Äπ</button>
                            <h3 id="currentMonth">December 2024</h3>
                            <button id="nextMonth" class="calendar-nav">‚Ä∫</button>
                        </div>
                        
                        <div class="calendar-grid" id="calendarGrid">
                            <div class="calendar-weekdays">
                                <div>Sun</div>
                                <div>Mon</div>
                                <div>Tue</div>
                                <div>Wed</div>
                                <div>Thu</div>
                                <div>Fri</div>
                                <div>Sat</div>
                            </div>
                            <div class="calendar-days" id="calendarDays">
                                <!-- Calendar days will be generated dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Entries -->
                    <div class="recent-entries">
                        <h3>üìÖ Recent Entries</h3>
                        <div id="recentLogEntries" class="log-entries-list">
                            <!-- Recent entries will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upgrade Tab Content -->
            <div id="upgradeTab" class="tab-content" style="display: none;">
                <div class="upgrade-section">
                    <div class="upgrade-header">
                        <h2>üöÄ Upgrade to Premium</h2>
                        <p>Get unlimited access to all features</p>
                    </div>
                    
                    <div class="upgrade-benefits">
                        <h3>‚ú® Premium Benefits</h3>
                        <div class="benefit-item">
                            <span>‚úì</span> Unlimited safety checks (vs 1/day free)
                        </div>
                        <div class="benefit-item">
                            <span>‚úì</span> üì∏ Camera & image analysis
                        </div>
                        <div class="benefit-item">
                            <span>‚úì</span> üî¨ Detailed medical reports
                        </div>
                        <div class="benefit-item">
                            <span>‚úì</span> üìÑ Export history as PDF
                        </div>
                        <div class="benefit-item">
                            <span>‚úì</span> No subscriptions or hidden fees
                        </div>
                    </div>

                    <div class="upgrade-pricing">
                        <!-- Monthly Plan -->
                        <div class="price-card" data-price-type="monthly">
                            <div class="price-label">Monthly</div>
                            <div class="price">$0.99<span style="font-size: 0.5em">/mo</span></div>
                            <div class="price-subtitle">Billed monthly</div>
                            <div class="price-features">
                                Cancel anytime ‚Ä¢ Auto-renews
                            </div>
                            <button class="upgrade-pay-btn" data-price="monthly" data-amount="$0.99/mo">
                                Choose Monthly
                            </button>
                        </div>
                        
                        <!-- Annual Plan -->
                        <div class="price-card featured" data-price-type="annual">
                            <div class="price-badge">BEST VALUE</div>
                            <div class="price-label">Annual</div>
                            <div class="price">$9.99<span style="font-size: 0.5em">/yr</span></div>
                            <div class="price-subtitle">Save 17%</div>
                            <div class="price-features">
                                Just $0.83/month ‚Ä¢ Billed yearly
                            </div>
                            <button class="upgrade-pay-btn" data-price="annual" data-amount="$9.99/yr">
                                Choose Annual
                            </button>
                        </div>
                        
                        <!-- Lifetime Plan -->
                        <div class="price-card" data-price-type="lifetime">
                            <div class="price-label">Lifetime</div>
                            <div class="price">$19.99</div>
                            <div class="price-subtitle">One-time payment</div>
                            <div class="price-features">
                                No subscriptions ‚Ä¢ Forever yours
                            </div>
                            <button class="upgrade-pay-btn" data-price="lifetime" data-amount="$19.99">
                                Get Lifetime Access
                            </button>
                        </div>
                    </div>

                    <div class="upgrade-actions">
                        
                        <div class="upgrade-loading" id="upgradeLoading" style="display: none;">
                            Processing payment...
                        </div>
                        
                        <div class="security-note">
                            üîí Secure payment processed by Stripe
                        </div>
                        
                        <!-- Error Message -->
                        <div id="upgradeErrorMessage" class="upgrade-error" style="display: none;"></div>
                        
                        <!-- Success Message -->
                        <div id="upgradeSuccessMessage" class="upgrade-success" style="display: none;"></div>
                    </div>
                </div>
            </div>

        </main>

        <footer>
            <p>This tool provides general information only. Always consult your healthcare provider for personalized medical advice.</p>
        </footer>
    </div>

    <!-- Log Entry Modal -->
    <div id="logModal" class="log-modal">
        <div class="log-modal-content">
            <div class="log-modal-header">
                <h2>üìù Log Entry Details</h2>
                <span class="log-modal-close" onclick="closeLogModal()">&times;</span>
            </div>
            <div class="log-modal-body" id="logModalBody">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <script>
        // Logout function
        function logout() {
            // Clear local storage
            localStorage.removeItem('authToken');
            localStorage.removeItem('isPremium');
            localStorage.removeItem('userEmail');
            
            // Clear session on server
            fetch('/auth/logout', {
                method: 'POST',
                credentials: 'include'
            }).then(() => {
                // Redirect to login page
                window.location.href = '/login';
            }).catch(() => {
                // Even if server logout fails, still redirect
                window.location.href = '/login';
            });
        }
        
        // Check if user is authenticated before loading app
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const trial = urlParams.get('trial');
            
            // Store token if provided in URL
            if (token) {
                localStorage.setItem('authToken', token);
            }
            
            // Check if we have a token or are in trial mode
            const storedToken = localStorage.getItem('authToken');
            
            if (!storedToken && !trial) {
                // No token and not trial, redirect to login
                window.location.href = '/login';
                return;
            }
            
            // Upgrade functionality
            let stripe = null;
            
            // Initialize Stripe
            fetch('/payment/config')
                .then(response => response.json())
                .then(config => {
                    if (config.publishableKey) {
                        stripe = Stripe(config.publishableKey);
                    }
                })
                .catch(error => console.error('Failed to load Stripe config:', error));
            
            // Upgrade payment handler
            function handleUpgradePayment(priceType) {
                const buttons = document.querySelectorAll('.upgrade-pay-btn');
                const loading = document.getElementById('upgradeLoading');
                const errorDiv = document.getElementById('upgradeErrorMessage');
                const successDiv = document.getElementById('upgradeSuccessMessage');
                
                // Disable all buttons
                buttons.forEach(btn => btn.disabled = true);
                loading.style.display = 'block';
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                
                // Create checkout session with price type
                fetch('/payment/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    },
                    body: JSON.stringify({ priceType: priceType })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Redirect to Stripe Checkout
                    return stripe.redirectToCheckout({
                        sessionId: data.sessionId
                    });
                })
                .then(result => {
                    if (result && result.error) {
                        throw new Error(result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);
                    errorDiv.textContent = error.message || 'Payment failed. Please try again.';
                    errorDiv.style.display = 'block';
                    // Re-enable all buttons
                    const buttons = document.querySelectorAll('.upgrade-pay-btn');
                    buttons.forEach(btn => btn.disabled = false);
                    loading.style.display = 'none';
                });
            }
            
            // Handle payment success from Stripe redirect
            function handlePaymentSuccess() {
                const urlParams = new URLSearchParams(window.location.search);
                const success = urlParams.get('success');
                const sessionId = urlParams.get('session_id');
                
                if (success === 'true' && sessionId) {
                    // Verify the payment session with backend
                    fetch('/payment/verify-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                        },
                        body: JSON.stringify({ sessionId })
                    })
                    .then(async (response) => {
                        // Accept both JSON and HTML (in case of edge error)
                        const text = await response.text();
                        try { return JSON.parse(text); } catch(_) { throw new Error('Verification response not JSON'); }
                    })
                    .then(data => {
                        if (data.success) {
                            // Update local storage
                            localStorage.setItem('isPremium', 'true');
                            
                            // Show success message
                            showUpgradeSuccess();
                            
                            // Clean up URL
                            window.history.replaceState({}, document.title, '/app.html');
                            
                            // Reload page to reflect premium status
                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        } else {
                            showUpgradeError('Payment verification failed');
                        }
                    })
                    .catch(error => {
                        console.error('Payment verification error:', error);
                        showUpgradeError('Failed to verify payment');
                    });
                }
            }
            
            function showUpgradeSuccess() {
                const upgradeTab = document.getElementById('upgradeTab');
                if (upgradeTab) {
                    upgradeTab.innerHTML = `
                        <div class="upgrade-section" style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                            <h2 style="color: #4CAF50; margin-bottom: 15px;">Welcome to Premium!</h2>
                            <p style="color: #666; font-size: 1.1rem; margin-bottom: 25px;">
                                Your payment was successful. You now have unlimited access to all features!
                            </p>
                            <div style="background: #e8f5e8; border-radius: 15px; padding: 20px; margin: 20px 0;">
                                <h3 style="color: #4CAF50; margin-bottom: 15px;">‚ú® You now have access to:</h3>
                                <div style="text-align: left; display: inline-block;">
                                    <div style="margin: 8px 0; color: #333;">‚úì Unlimited safety checks</div>
                                    <div style="margin: 8px 0; color: #333;">‚úì Image analysis with camera</div>
                                    <div style="margin: 8px 0; color: #333;">‚úì Detailed medical reports</div>
                                    <div style="margin: 8px 0; color: #333;">‚úì Export history as PDF</div>
                                </div>
                            </div>
                            <button onclick="document.querySelector('[data-tab=\\"search\\"]').click()" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 10px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                cursor: pointer;
                                margin-top: 20px;
                            ">üöÄ Start Using Premium Features</button>
                        </div>
                    `;
                    
                    // Switch to upgrade tab to show success
                    document.querySelector('[data-tab="upgrade"]').click();
                }
            }
            
            function showUpgradeError(message) {
                const errorDiv = document.getElementById('upgradeErrorMessage');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            }

            // Check if user is authenticated for premium features
            function checkAuthForUpgrade() {
                const authToken = localStorage.getItem('authToken');
                const urlParams = new URLSearchParams(window.location.search);
                const isTrial = urlParams.get('trial') === 'true';
                
                // If no token and not in trial mode, or if explicitly in trial mode, require login
                if (!authToken || isTrial) {
                    return false;
                }
                
                return true;
            }
            
            // Show login required message for upgrade
            function showLoginRequired() {
                const upgradeTab = document.getElementById('upgradeTab');
                if (upgradeTab) {
                    upgradeTab.innerHTML = `
                        <div class="upgrade-section" style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 3rem; margin-bottom: 20px;">üîê</div>
                            <h2 style="color: #667eea; margin-bottom: 15px;">Login Required</h2>
                            <p style="color: #666; font-size: 1.1rem; margin-bottom: 25px;">
                                Please log in with your email to upgrade to premium features.
                            </p>
                            <div style="background: #f0f8ff; border-radius: 15px; padding: 20px; margin: 20px 0;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">Why create an account?</h3>
                                <div style="text-align: left; display: inline-block;">
                                    <div style="margin: 8px 0; color: #333;">‚úì Secure payment processing</div>
                                    <div style="margin: 8px 0; color: #333;">‚úì Access your premium features anywhere</div>
                                    <div style="margin: 8px 0; color: #333;">‚úì Sync your search history</div>
                                    <div style="margin: 8px 0; color: #333;">‚úì Account recovery options</div>
                                </div>
                            </div>
                            <button onclick="window.location.href='/login'" style="
                                background: #667eea;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 10px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                cursor: pointer;
                                margin: 10px;
                                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                            ">üöÄ Login & Upgrade</button>
                            <br>
                            <button onclick="document.querySelector('[data-tab=\\"search\\"]').click()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-size: 1rem;
                                cursor: pointer;
                                margin: 10px;
                            ">Continue with Trial</button>
                        </div>
                    `;
                }
            }

            // Add event listener for upgrade buttons when DOM is ready
            document.addEventListener('DOMContentLoaded', () => {
                // Apply premium badge
                const isPremium = localStorage.getItem('isPremium') === 'true';
                if (isPremium) {
                    const header = document.querySelector('header h1');
                    if (header && !header.textContent.includes('‚≠ê')) {
                        header.textContent = 'ü§∞Safebut? ‚≠ê';
                    }
                }
                // Handle all upgrade buttons
                const upgradeButtons = document.querySelectorAll('.upgrade-pay-btn');
                upgradeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const priceType = e.target.dataset.price;
                        if (priceType) {
                            handleUpgradePayment(priceType);
                        }
                    });
                });
                
                // Add authentication check for upgrade tab
                const upgradeTabBtn = document.querySelector('[data-tab="upgrade"]');
                if (upgradeTabBtn) {
                    upgradeTabBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (!checkAuthForUpgrade()) {
                            // Show login required message
                            showLoginRequired();
                            
                            // Switch to upgrade tab but show login message
                            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                            
                            upgradeTabBtn.classList.add('active');
                            document.getElementById('upgradeTab').classList.add('active');
                        } else {
                            // Allow normal tab switching for authenticated users
                            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                            
                            upgradeTabBtn.classList.add('active');
                            document.getElementById('upgradeTab').classList.add('active');
                        }
                    });
                }
                
                // Check for payment success
                handlePaymentSuccess();
            });

            // Load the main app script after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    const script = document.createElement('script');
                    script.src = 'app.js';
                    document.body.appendChild(script);
                });
            } else {
                // DOM already loaded
                const script = document.createElement('script');
                script.src = 'app.js';
                document.body.appendChild(script);
            }
        })();
    </script>
</body>
</html>