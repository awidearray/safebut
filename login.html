<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Safe Maternity</title>
    <meta name="theme-color" content="#b8956a">
    
    <!-- Standard favicon -->
    <link rel="icon" type="image/png" href="/logo.png">
    
    <link rel="stylesheet" href="globals.css">
    <script src="theme-switcher.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background-secondary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-container {
            background: var(--background-primary);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            padding: 40px 30px;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
            text-align: center;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.75rem;
            text-align: center;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            text-align: center;
            font-size: 0.95rem;
        }

        .free-badge {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            margin: 0 auto 25px;
            text-align: center;
            width: fit-content;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
        }

        .free-badge svg {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }

        .email-input-group {
            margin-bottom: 20px;
        }

        .email-input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .email-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .email-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .signup-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .signup-button:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .signup-button:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
            color: #999;
            font-size: 0.85rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 30px);
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .premium-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .premium-info h3 {
            color: #764ba2;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .premium-price {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .premium-price small {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: normal;
        }

        .premium-features {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .terms-checkbox {
            margin-bottom: 20px;
        }

        .terms-checkbox label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .terms-checkbox input {
            margin-right: 8px;
            margin-top: 3px;
            cursor: pointer;
            flex-shrink: 0;
            min-width: 16px;
        }

        .terms-checkbox span {
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
        }

        .terms-checkbox a {
            color: var(--primary-color);
            text-decoration: none;
            white-space: nowrap;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        /* Mobile-specific fixes */
        @media (max-width: 600px) {
            .terms-checkbox label {
                font-size: 0.8rem;
            }
            
            .terms-checkbox span {
                line-height: 1.5;
            }
            
            /* Allow links to wrap on very small screens */
            @media (max-width: 380px) {
                .terms-checkbox a {
                    white-space: normal;
                }
            }
        }

        .already-account {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .already-account a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .already-account a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
        }

        .benefits {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            display: none;
        }

        .pricing {
            display: none;
        }

        .email-login-button {
            display: none;
        }

        .skip-link {
            display: none;
        }

        @media (max-width: 600px) {
            .login-container {
                padding: 30px 20px;
                margin-top: 60px; /* Add space for theme switcher at top */
                margin-bottom: 40px; /* Ensure content isn't cut off */
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            /* Ensure button has enough tap area and isn't blocked */
            .signup-button {
                padding: 16px 20px;
                margin-bottom: 25px;
                position: relative;
                z-index: 10;
            }
        }
    </style>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/logo.png">
</head>
<body>
    <div class="login-container">
        <div class="logo"><img src="/logo.png" alt="Safe Maternity Logo" style="width: 90px; height: 90px;"></div>
        <h1>Create Your Account</h1>
        <p class="subtitle">Join Safe Maternity for pregnancy safety guidance</p>

        <div class="free-badge">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            FREE to sign up
        </div>

        <div id="errorMessage" class="error-message"></div>

        <div class="email-input-group">
            <label for="email-input">Email Address</label>
            <input type="email" id="email-input" class="email-input" placeholder="you@example.com" autocomplete="email">
        </div>

        <div class="terms-checkbox">
            <label>
                <input type="checkbox" id="terms-checkbox">
                <span>I accept the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/policy" target="_blank">Privacy Policy</a></span>
            </label>
        </div>

        <button onclick="signUpWithEmail()" class="signup-button" id="signup-button">
            Create Free Account
        </button>

        <div class="divider">or</div>

        <div class="premium-info">
            <h3>ðŸŒŸ Go Premium</h3>
            <div class="premium-price">
                $0.99 <small>/month</small>
            </div>
            <div class="premium-features">
                Unlimited checks â€¢ Image analysis â€¢ Export reports
            </div>
        </div>

        <div class="already-account">
            Already have an account? <a href="#" onclick="showLoginForm(); return false;">Sign in</a>
        </div>
    </div>

    <script>
        // Sign up with email
        function signUpWithEmail() {
            // Check if terms are accepted
            const termsCheckbox = document.getElementById('terms-checkbox');
            if (!termsCheckbox.checked) {
                showError('Please accept the Terms of Service and Privacy Policy to continue');
                return;
            }
            
            const email = document.getElementById('email-input').value;
            
            if (!email || !email.includes('@')) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Use the existing loginWithEmail logic
            loginWithEmail();
        }
        
        // Show login form (for existing users)
        function showLoginForm() {
            // For now, use the same form but change the button text
            const title = document.querySelector('h1');
            const subtitle = document.querySelector('.subtitle');
            const button = document.querySelector('.signup-button');
            const freeBadge = document.querySelector('.free-badge');
            const alreadyAccount = document.querySelector('.already-account');
            
            title.textContent = 'Welcome Back';
            subtitle.textContent = 'Sign in to your Safe Maternity account';
            button.textContent = 'Sign In';
            if (freeBadge) freeBadge.style.display = 'none';
            alreadyAccount.innerHTML = 'Don\'t have an account? <a href="#" onclick="location.reload(); return false;">Sign up</a>';
        }
        
        // Email magic link function
        function loginWithEmail() {
            const email = document.getElementById('email-input').value;
            const button = document.getElementById('signup-button');
            
            if (!email || !email.includes('@')) {
                showError('Please enter a valid email address');
                return;
            }
            
            // Get referral code from URL if present
            const urlParams = new URLSearchParams(window.location.search);
            const referralCode = urlParams.get('ref');
            
            // Show loading state
            if (button) {
                const originalText = button.textContent;
                button.textContent = 'Sending magic link...';
                button.disabled = true;
            }
            
            // Request magic link - using the correct endpoint
            fetch('/auth/request-magic-link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, referralCode }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showSuccess(data.message);
                    
                    // In development, show the magic link
                    if (data.magicLink) {
                        showMagicLinkDemo(data.magicLink);
                    } else {
                        showEmailSentMessage(email);
                    }
                } else {
                    showError(data.error || 'Failed to send magic link');
                    if (button) {
                        button.textContent = 'Create Free Account';
                        button.disabled = false;
                    }
                }
            })
            .catch(error => {
                console.error('Magic link error:', error);
                showError('Failed to send magic link. Please try again.');
                if (button) {
                    button.textContent = 'Create Free Account';
                    button.disabled = false;
                }
            });
        }
        
        // Enter key support for email input
        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('email-input');
            if (emailInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginWithEmail();
                    }
                });
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#f8d7da';
            errorDiv.style.color = '#721c24';
        }
        
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#d4edda';
            errorDiv.style.color = '#155724';
        }
        
        function showMagicLinkDemo(magicLink) {
            const container = document.querySelector('.login-container');
            const demoDiv = document.createElement('div');
            demoDiv.innerHTML = `
                <div style="background: #e7f3ff; border: 2px solid #0066cc; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center;">
                    <h3 style="color: #0066cc; margin-bottom: 15px;">ðŸ”— Development Mode</h3>
                    <p style="margin-bottom: 15px; color: #333;">In development, here's your magic link:</p>
                    <a href="${magicLink}" style="
                        display: inline-block;
                        background: #0066cc;
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        text-decoration: none;
                        font-weight: 600;
                        margin: 10px 0;
                    ">ðŸš€ Click to Login</a>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        This link expires in 15 minutes
                    </p>
                </div>
            `;
            container.appendChild(demoDiv);
        }
        
        function showEmailSentMessage(email) {
            const container = document.querySelector('.login-container');
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `
                <div style="background: #e8f5e8; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center;">
                    <h3 style="color: #4CAF50; margin-bottom: 15px;">ðŸ“§ Check Your Email</h3>
                    <p style="margin-bottom: 10px; color: #333;">
                        We've sent a secure login link to:<br>
                        <strong>${email}</strong>
                    </p>
                    <p style="font-size: 0.9em; color: #666;">
                        Click the link in your email to log in securely.<br>
                        The link expires in 15 minutes.
                    </p>
                    <button onclick="location.reload()" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 15px;
                    ">Send Another Link</button>
                </div>
            `;
            container.appendChild(messageDiv);
        }

        // Check for auth errors in URL
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        
        if (error === 'auth_failed') {
            showError('Authentication failed. Please try again.');
        } else if (error === 'invalid_token') {
            showError('Invalid or expired magic link. Please request a new one.');
        } else if (error === 'token_used') {
            showError('This magic link has already been used. Please request a new one.');
        } else if (error === 'token_expired') {
            showError('Magic link has expired. Please request a new one.');
        }

    </script>

</body>
</html>